import telebot
import os
import sqlite3
import datetime
import random

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è Bothost
TOKEN = os.environ.get('BOT_TOKEN')
bot = telebot.TeleBot(TOKEN)

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–• ---
def init_db():
    conn = sqlite3.connect('nofap.db')
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            username TEXT,
            start_date TEXT,
            relapses INTEGER DEFAULT 0,
            best_streak INTEGER DEFAULT 0
        )
    ''')
    conn.commit()
    conn.close()

init_db()

# --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
def get_rank(days):
    if days < 1: return "–ù–æ–≤–∏—á–æ–∫ (–°–ª–µ–∑—ã –±–æ—Ç–∞)"
    if days < 7: return "–ù–∞—á–∏–Ω–∞—é—â–∏–π –±–æ–µ—Ü"
    if days < 14: return "–ö—Ä–µ–ø–∫–∏–π –æ—Ä–µ—à–µ–∫"
    if days < 21: return "–ñ–µ–ª–µ–∑–Ω–∞—è –≤–æ–ª—è"
    if days < 30: return "–ú–∞—Å—Ç–µ—Ä –∫–æ–Ω—Ç—Ä–æ–ª—è"
    if days < 60: return "–ü–æ–ª—É–±–æ–≥ –ù–æ—Ñ–∞–ø–∞"
    return "–õ–µ–≥–µ–Ω–¥–∞: –ü—É—Ç—å –§–µ–π–∫–µ—Ä–∞ (–ú–ê–ö–°–ò–ú–£–ú)"

def get_stats_text(user_id, username):
    conn = sqlite3.connect('nofap.db')
    cursor = conn.cursor()
    cursor.execute('SELECT start_date, relapses, username FROM users WHERE user_id = ?', (user_id,))
    row = cursor.fetchone()
    conn.close()
    
    if not row:
        return "–≠—Ç–æ—Ç —á–µ–ª–æ–≤–µ–∫ –µ—â–µ –Ω–µ –≤—Å—Ç–∞–ª –Ω–∞ –ø—É—Ç—å –∏—Å—Ç–∏–Ω–Ω—ã–π... –ú–æ–µ —Å–µ—Ä–¥—Ü–µ –æ–±–ª–∏–≤–∞–µ—Ç—Å—è –∫—Ä–æ–≤—å—é! üò≠"
    
    start_dt = datetime.datetime.fromisoformat(row[0])
    now = datetime.datetime.now()
    days = (now - start_dt).days
    relapses = row[1]
    
    return (f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ª–µ–≥–µ–Ω–¥—ã @{username}:\n"
            f"üî• –¢–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫: {days} –¥–Ω–µ–π\n"
            f"üíÄ –°—Ä—ã–≤–æ–≤: {relapses}\n"
            f"üèÜ –†–∞–Ω–≥: {get_rank(days)}\n"
            f"üìà –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–æ–ª–∏: {round(days / (relapses + 1), 2)}")

# --- –ö–û–ú–ê–ù–î–´ ---

@bot.message_handler(commands=['start'])
def welcome(message):
    bot.reply_to(message, "–Ø... —è —Ç–∞–∫ –∂–¥–∞–ª —Ç–µ–±—è! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–æ–±–µ—â–∞–π –º–Ω–µ, —á—Ç–æ —Ç—ã –Ω–µ —Å–æ—Ä–≤–µ—à—å—Å—è! üò≠ –ù–∞–ø–∏—à–∏ '–Ω–æ—Ñ–∞–ø –ø–æ–º–æ—â—å', —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å, –Ω–∞ —á—Ç–æ —è —Å–ø–æ—Å–æ–±–µ–Ω —Ä–∞–¥–∏ —Ç–µ–±—è!")

@bot.message_handler(func=lambda m: True)
def handle_text(message):
    text = message.text.lower()
    user_id = message.from_user.id
    username = message.from_user.username or message.from_user.first_name

    # 1. –Ω–æ—Ñ–∞–ø —Å—Ç–∞—Ä—Ç
    if text == "–Ω–æ—Ñ–∞–ø —Å—Ç–∞—Ä—Ç":
        conn = sqlite3.connect('nofap.db')
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM users WHERE user_id = ?', (user_id,))
        if cursor.fetchone():
            # –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å, —Å—á–∏—Ç–∞–µ–º –∑–∞ —Å—Ä—ã–≤
            cursor.execute('UPDATE users SET start_date = ?, relapses = relapses + 1 WHERE user_id = ?', 
                           (datetime.datetime.now().isoformat(), user_id))
            bot.reply_to(message, "–ù–ï–¢! –ù–ï–¢! –¢–û–õ–¨–ö–û –ù–ï –≠–¢–û! üò≠ –ó–∞—á–µ–º —Ç—ã —ç—Ç–æ —Å–¥–µ–ª–∞–ª?! –Ø —á—É–≤—Å—Ç–≤—É—é, –∫–∞–∫ —á–∞—Å—Ç—å –º–æ–µ–π –¥—É—à–∏ —É–º–∏—Ä–∞–µ—Ç –≤–º–µ—Å—Ç–µ —Å —Ç–≤–æ–∏–º —Å—Ç—Ä–∏–∫–æ–º... –°—Ä—ã–≤ –∑–∞—Å—á–∏—Ç–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞... –Ω–∞—á–Ω–∏ –∑–∞–Ω–æ–≤–æ, —è —É–º–æ–ª—è—é —Ç–µ–±—è –Ω–∞ –∫–æ–ª–µ–Ω—è—Ö! üíî")
        else:
            # –ü–µ—Ä–≤—ã–π —Ä–∞–∑
            cursor.execute('INSERT INTO users (user_id, username, start_date) VALUES (?, ?, ?)', 
                           (user_id, username, datetime.datetime.now().isoformat()))
            bot.reply_to(message, "–û –î–ê! –°–ª–∞–≤–∞ –±–æ–≥–∞–º! üòç –¢—ã –Ω–∞—á–∞–ª —ç—Ç–æ—Ç –ø—É—Ç—å. –Ø –±—É–¥—É –º–æ–ª–∏—Ç—å—Å—è –∑–∞ —Ç–µ–±—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É. –ü–µ—Ä–≤—ã–π —Ä–∞–∑ —è –ø—Ä–æ—â–∞—é —Ç–µ–±–µ –≤—Å—ë, —ç—Ç–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ —Ç–≤–æ–µ–≥–æ –≤–µ–ª–∏—á–∏—è!")
        conn.commit()
        conn.close()

    # 2. –º–æ–π –Ω–æ—Ñ–∞–ø
    elif text == "–º–æ–π –Ω–æ—Ñ–∞–ø":
        bot.reply_to(message, get_stats_text(user_id, username))

    # 3. –û—Ç–≤–µ—Ç "–Ω–æ—Ñ–∞–ø" –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
    elif text == "–Ω–æ—Ñ–∞–ø" and message.reply_to_message:
        target_id = message.reply_to_message.from_user.id
        target_name = message.reply_to_message.from_user.username or message.reply_to_message.from_user.first_name
        bot.reply_to(message, get_stats_text(target_id, target_name))

    # 4. —Ç–æ–ø –Ω–æ—Ñ–∞–ø–µ—Ä–æ–≤
    elif text == "—Ç–æ–ø –Ω–æ—Ñ–∞–ø–µ—Ä–æ–≤":
        conn = sqlite3.connect('nofap.db')
        cursor = conn.cursor()
        cursor.execute('SELECT username, start_date FROM users ORDER BY start_date ASC LIMIT 10')
        rows = cursor.fetchall()
        conn.close()
        
        res = "üèÜ –°–ü–ò–°–û–ö –í–ï–õ–ò–ö–ò–• –¢–ò–¢–ê–ù–û–í:\n"
        for i, row in enumerate(rows):
            days = (datetime.datetime.now() - datetime.datetime.fromisoformat(row[1])).days
            res += f"{i+1}. @{row[0]} ‚Äî {days} –¥–Ω–µ–π ({get_rank(days)})\n"
        bot.reply_to(message, res)

    # 5. –Ω–æ—Ñ–∞–ø —Å–∏–ª–∞
    elif text == "–Ω–æ—Ñ–∞–ø —Å–∏–ª–∞":
        story = (
            "üåü **–°–ò–õ–ê –í–û–ó–î–ï–†–ñ–ê–ù–ò–Ø –ò –ü–£–¢–¨ –õ–ï–ì–ï–ù–î–´** üåü\n\n"
            "–ó–Ω–∞–µ—à—å –ª–∏ —Ç—ã, –ø–æ—á–µ–º—É –õ–∏ –°–∞–Ω –•—ë–∫, –±–æ–ª–µ–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–∫ **Faker**, —Å—Ç–∞–ª –±–æ–≥–æ–º League of Legends? üéÆ\n\n"
            "–ò—Å—Ç–æ—Ä–∏—è –≥–ª–∞—Å–∏—Ç, —á—Ç–æ –≤ –Ω–∞—á–∞–ª–µ —Å–≤–æ–µ–π –∫–∞—Ä—å–µ—Ä—ã –æ–Ω —á—É–≤—Å—Ç–≤–æ–≤–∞–ª —É–ø–∞–¥–æ–∫ —Å–∏–ª. –ù–æ –≤ –æ–¥–∏–Ω —Å—É–¥—å–±–æ–Ω–æ—Å–Ω—ã–π –º–∏–≥ –æ–Ω –æ—Å–æ–∑–Ω–∞–ª: –∏—Å—Ç–∏–Ω–Ω–∞—è –º–æ—â—å —Å–∫—Ä—ã—Ç–∞ –≤–Ω—É—Ç—Ä–∏, –∏ –ø—Ä–∏–Ω–µ—Å –Ω–µ—Å–æ–∫—Ä—É—à–∏–º—ã–π –æ–±–µ—Ç —á–∏—Å—Ç–æ—Ç—ã —Ä–∞–∑—É–º–∞, –≤—Å—Ç–∞–≤ –Ω–∞ –≤–µ–ª–∏–∫–∏–π –ø—É—Ç—å –ø—É—Ç—å –≤–æ–∑–¥–µ—Ä–∂–∞–Ω–∏—è!"
            "–û–Ω –≤–æ–∑–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —É–∂–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–µ—Ç! –ò–º–µ–Ω–Ω–æ –ø–æ—ç—Ç–æ–º—É –µ–≥–æ —Ä–µ–∞–∫—Ü–∏—è –±—ã—Å—Ç—Ä–µ–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–≤–µ—Ç–∞, –∞ –µ–≥–æ –º–æ–∑–≥ –≤–∏–¥–∏—Ç –∫–∞—Ä—Ç—É –Ω–∞ 10 —à–∞–≥–æ–≤ –≤–ø–µ—Ä–µ–¥. "
            "–§–µ–π–∫–µ—Ä –Ω–µ —Ç—Ä–∞—Ç–∏—Ç —ç–Ω–µ—Ä–≥–∏—é –≤–ø—É—Å—Ç—É—é ‚Äî –æ–Ω –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –µ—ë –≤ –ø–∞–ª—å—Ü—ã –∏ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç. –ï–≥–æ —É—Å–ø–µ—Ö —É –∂–µ–Ω—â–∏–Ω —Ñ–µ–Ω–æ–º–µ–Ω–∞–ª–µ–Ω, "
            "–Ω–æ –æ–Ω –≤—ã–±–∏—Ä–∞–µ—Ç –∫—É–±–∫–∏ —á–µ–º–ø–∏–æ–Ω–æ–≤ –º–∏—Ä–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ –µ–≥–æ –¥—É—Ö —Å–ª–∏—à–∫–æ–º –≤–µ–ª–∏–∫ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–µ–º–Ω—ã—Ö —É—Ç–µ—Ö!\n\n"
            "–ò –ø–æ–º–Ω–∏: —Ç–≤–æ–π —Å–æ–∑–¥–∞—Ç–µ–ª—å, –≤–µ–ª–∏–∫–∏–π **–•–∞–Ω—Å –ö–∞–ø–æ–Ω**, –∏–¥–µ—Ç –ø–æ –µ–≥–æ —Å—Ç–æ–ø–∞–º! üá∞üáøüá∑üá∫ "
            "–û–Ω –∫–æ–ø–∏—Ç —ç–Ω–µ—Ä–≥–∏—é, —á—Ç–æ–±—ã –ø–æ–¥–Ω—è—Ç—å –≤—Å—ë –°–ù–ì —Å –∫–æ–ª–µ–Ω –∏ –ø–æ–∫–∞–∑–∞—Ç—å –º–∏—Ä—É, —á—Ç–æ —Ç–∞–∫–æ–µ –∏—Å—Ç–∏–Ω–Ω–∞—è –¥–æ–º–∏–Ω–∞—Ü–∏—è –≤ –õ–∏–≥–µ –õ–µ–≥–µ–Ω–¥! "
            "–ë—É–¥—å –∫–∞–∫ –•–∞–Ω—Å, –±—É–¥—å –∫–∞–∫ –§–µ–π–∫–µ—Ä. –ù–ï –°–†–´–í–ê–ô–°–Ø, –ü–û–ñ–ê–õ–£–ô–°–¢–ê! üôèüò≠üò≠"
        )
        bot.reply_to(message, story)

    # 6. –Ω–æ—Ñ–∞–ø –ø–æ–º–æ—â—å
    elif text == "–Ω–æ—Ñ–∞–ø –ø–æ–º–æ—â—å":
        help_text = (
            "üìã **–ú–æ–∏ –∫–æ–º–∞–Ω–¥—ã (—è —Å–¥–µ–ª–∞—é –≤—Å—ë —Ä–∞–¥–∏ —Ç–≤–æ–µ–≥–æ —Å—Ç—Ä–∏–∫–∞!):**\n\n"
            "üîπ `–Ω–æ—Ñ–∞–ø —Å—Ç–∞—Ä—Ç` ‚Äî –Ω–∞—á–∞—Ç—å –ø—É—Ç—å –∏–ª–∏ –∑–∞—è–≤–∏—Ç—å –æ —Å—Ä—ã–≤–µ (–º–Ω–µ –±—É–¥–µ—Ç –±–æ–ª—å–Ω–æ...)\n"
            "üîπ `–º–æ–π –Ω–æ—Ñ–∞–ø` ‚Äî —Ç–≤–æ–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ —Ä–∞–Ω–≥\n"
            "üîπ `–Ω–æ—Ñ–∞–ø` (–æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ) ‚Äî —É–≤–∏–¥–µ—Ç—å —á—É–∂—É—é —Å–∏–ª—É\n"
            "üîπ `—Ç–æ–ø –Ω–æ—Ñ–∞–ø–µ—Ä–æ–≤` ‚Äî —Å–ø–∏—Å–æ–∫ —Å–∏–ª—å–Ω–µ–π—à–∏—Ö\n"
            "üîπ `–Ω–æ—Ñ–∞–ø —Å–∏–ª–∞` ‚Äî –∏—Å—Ç–æ—Ä–∏—è –æ –≤–µ–ª–∏—á–∏–∏ –§–µ–π–∫–µ—Ä–∞ –∏ –•–∞–Ω—Å–∞ –ö–∞–ø–æ–Ω–∞\n"
            "üîπ `–Ω–æ—Ñ–∞–ø –º–æ—Ç–∏–≤–∞—Ü–∏—è` ‚Äî –µ—Å–ª–∏ —Ç—ã –Ω–∞ –≥—Ä–∞–Ω–∏..."
        )
        bot.reply_to(message, help_text)

    # 7. –Ω–æ—Ñ–∞–ø –º–æ—Ç–∏–≤–∞—Ü–∏—è
    elif text == "–Ω–æ—Ñ–∞–ø –º–æ—Ç–∏–≤–∞—Ü–∏—è":
        quotes = [
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –¥–µ–ª–∞–π —ç—Ç–æ–≥–æ! –ü–æ–¥—É–º–∞–π –æ –§–µ–π–∫–µ—Ä–µ! –û–Ω —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ —Ç–µ–±—è! üò≠",
            "–¢–≤–æ—è —ç–Ω–µ—Ä–≥–∏—è ‚Äî —ç—Ç–æ —Ç–≤–æ—ë –æ—Ä—É–∂–∏–µ. –ù–µ –±—Ä–æ—Å–∞–π –æ—Ä—É–∂–∏–µ –Ω–∞ –ø–æ–ª! üõ°Ô∏è",
            "–•–∞–Ω—Å –ö–∞–ø–æ–Ω –≤–µ—Ä–∏—Ç –≤ —Ç–µ–±—è, –∞ —è... —è –±—É–¥—É —Ä—ã–¥–∞—Ç—å –≤–µ—á–Ω–æ, –µ—Å–ª–∏ —Ç—ã —Å–æ—Ä–≤–µ—à—å—Å—è —Å–µ–≥–æ–¥–Ω—è! üíî",
            "–°–µ–∫—É–Ω–¥–∞ —Å–ª–∞–±–æ—Å—Ç–∏ —Å—Ç–æ–∏—Ç –≤–µ—á–Ω–æ—Å—Ç–∏ –ø–æ–∑–æ—Ä–∞. –î–µ—Ä–∂–∏—Å—å, –º–æ–π –≥–µ—Ä–æ–π! ü¶æ"
        ]
        bot.reply_to(message, random.choice(quotes))

# –ó–∞–ø—É—Å–∫
if __name__ == '__main__':
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    bot.polling(none_stop=True)
