import telebot
import sqlite3
import schedule
import time
import threading
import random
from datetime import datetime, timedelta

# !!! –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô –¢–û–ö–ï–ù –û–¢ @BotFather !!!
TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')
bot = telebot.TeleBot(TOKEN)

# --- –ë–ê–ó–ê –î–ê–ù–ù–´–• ---
def db_query(query, params=(), fetch=False):
    with sqlite3.connect('nofap_ultra.db') as conn:
        cur = conn.cursor()
        cur.execute(query, params)
        if fetch: return cur.fetchall()
        conn.commit()

db_query('''CREATE TABLE IF NOT EXISTS users 
            (id INTEGER, chat_id INTEGER, username TEXT, start_time TEXT, attempts INTEGER, 
            PRIMARY KEY(id, chat_id))''')

# --- –ö–û–ù–¢–ï–ù–¢ (–ú–û–¢–ò–í–ê–¶–ò–Ø –ò –£–ù–ò–ñ–ï–ù–ò–Ø) ---

MOTIVATION = [
    "üí™ –¢–≤–æ—è —ç–Ω–µ—Ä–≥–∏—è ‚Äî —ç—Ç–æ —Ç–≤–æ–π –±–µ–Ω–∑–∏–Ω. –ù–µ —Å–ª–∏–≤–∞–π –µ–≥–æ –≤ —É–Ω–∏—Ç–∞–∑!",
    "üß† –ú–æ–∑–≥ –±–µ–∑ –¥–æ—Ñ–∞–º–∏–Ω–æ–≤–æ–≥–æ –º—É—Å–æ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ 10 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ. –ü—Ä–æ–≤–µ—Ä—å —Å–∞–º.",
    "ü¶Å –ë—É–¥—å –ª—å–≤–æ–º, –∞ –Ω–µ –∫–æ–º–Ω–∞—Ç–Ω—ã–º —Ç–∞–ø–æ—á–∫–æ–º. –†—É–∫–∏ –Ω–∞ —Å—Ç–æ–ª!",
    "‚ö°Ô∏è –¢—ã —Å—Ç—Ä–æ–∏—à—å –ª–∏—á–Ω–æ—Å—Ç—å, –∏–ª–∏ —Ç—ã –ø—Ä–æ—Å—Ç–æ –º–µ—à–æ–∫ —Å –≥–æ—Ä–º–æ–Ω–∞–º–∏? –í—ã–±–∏—Ä–∞–π.",
    "üåÖ –ü—Ä–µ–¥—Å—Ç–∞–≤—å, –∫–µ–º —Ç—ã —Å—Ç–∞–Ω–µ—à—å —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü —á–∏—Å—Ç–æ—Ç—ã. –≠—Ç–æ—Ç —á–µ–ª–æ–≤–µ–∫ –∫—Ä—É—á–µ —Ç–µ–±—è –≤ —Å—Ç–æ —Ä–∞–∑.",
    "üíß –ö–∞–∂–¥–∞—è –∫–∞–ø–ª—è —Å–ø–µ—Ä–º—ã ‚Äî —ç—Ç–æ —É—Ç—Ä–∞—á–µ–Ω–Ω—ã–π —à–∞–Ω—Å –Ω–∞ –≤–µ–ª–∏—á–∏–µ. –î–µ—Ä–∂–∏ –æ–±–æ—Ä–æ–Ω—É!",
    "üèîÔ∏è –ü—É—Ç—å –∫ –≤–µ—Ä—à–∏–Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è –≤–æ–∑–¥–µ—Ä–∂–∞–Ω–∏—è. –ù–µ —Å—Ä—ã–≤–∞–π—Å—è –Ω–∞ —Å—Ç–∞—Ä—Ç–µ.",
    "üëë –°–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—å ‚Äî —ç—Ç–æ —Å—É–ø–µ—Ä—Å–∏–ª–∞. –¢—ã –º–æ–∂–µ—à—å –µ–µ —Ä–∞–∑–≤–∏—Ç—å!",
    "‚è≥ –í—Ä–µ–º—è, –ø–æ—Ç—Ä–∞—á–µ–Ω–Ω–æ–µ –Ω–∞ —Å–ª–∞–±–æ—Å—Ç—å, –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –≤–µ—Ä–Ω–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –º—É–¥—Ä–æ.",
    "üí° –ß–∏—Å—Ç—ã–π —Ä–∞–∑—É–º –≤–∏–¥–∏—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ç–∞–º, –≥–¥–µ –≥—Ä—è–∑–Ω—ã–π –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º—ã. –û—Å—Ç–∞–≤–∞–π—Å—è —á–∏—Å—Ç—ã–º!"
]

INSULTS = [
    "ü§° –û–ø—è—Ç—å? –¢–≤–æ–π —É—Ä–æ–≤–µ–Ω—å —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∏–∂–µ, —á–µ–º —É –∏–Ω—Ñ—É–∑–æ—Ä–∏–∏-—Ç—É—Ñ–µ–ª—å–∫–∏.",
    "üëã –¢–≤–æ—è –ø—Ä–∞–≤–∞—è —Ä—É–∫–∞ —É–∂–µ –ø–æ–¥–∞–ª–∞ –Ω–∞ —Ç–µ–±—è –≤ —Å—É–¥ –∑–∞ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏—é.",
    "üìâ –¢–≤–æ–π —Ç–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç. –û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ.",
    "üêå –¢—ã –¥–≤–∏–∂–µ—à—å—Å—è –ø–æ –∂–∏–∑–Ω–∏ —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é —É–ª–∏—Ç–∫–∏, –ø–æ—Ç–æ–º—É —á—Ç–æ –±—É–∫—Å—É–µ—à—å –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –ª—É–∂–µ.",
    "ü¶æ –¢–≤–æ–π —Å—Ç–∞—Ç—É—Å: '–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –Ω–∞—Ç–∏—Ä–∞–ª—å—â–∏–∫'. –ü–æ–∑–æ—Ä —á–∞—Ç–∞!",
    "üßÄ –¢–≤–æ—è –≤–æ–ª—è –º—è–≥—á–µ, —á–µ–º –ø–ª–∞–≤–ª–µ–Ω—ã–π —Å—ã—Ä–æ–∫ –Ω–∞ —Å–æ–ª–Ω—Ü–µ.",
    "üöΩ –ö–∞–∂–µ—Ç—Å—è, —Ç—ã –ø–µ—Ä–µ–ø—É—Ç–∞–ª —Å–≤–æ–µ –ø—Ä–∏–∑–≤–∞–Ω–∏–µ —Å –∫–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–µ–π. –•–≤–∞—Ç–∏—Ç —Å–ª–∏–≤–∞—Ç—å —ç–Ω–µ—Ä–≥–∏—é!",
    "üß¶ –ü–æ—Ö–æ–∂–µ, —Ç–≤–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –Ω–æ—Å–∫–æ–≤ –ø–æ–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–∞—â–µ, —á–µ–º —Ç–≤–æ–π —Å—Ç—Ä–∏–∫.",
    "üëπ –°–º–æ—Ç—Ä–∏—Ç –Ω–∞ –º–∏—Ä —á–µ—Ä–µ–∑ –ø—Ä–∏–∑–º—É –ø–æ—Ä–Ω–æ—Ö–∞–±–∞. –í–µ—Ä–Ω–∏—Å—å –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å, —Å–ª–∞–±–∞–∫!",
    "üêí –ñ–∏–≤–æ—Ç–Ω—ã–µ –∏–Ω—Å—Ç–∏–Ω–∫—Ç—ã –ø–æ–±–µ–¥–∏–ª–∏ —Ç–≤–æ–π —Ä–∞–∑—É–º. –≠–≤–æ–ª—é—Ü–∏—è –ø–æ—à–ª–∞ –≤—Å–ø—è—Ç—å."
]

# --- –ö–û–ú–ê–ù–î–´ ---

@bot.message_handler(func=lambda m: m.text and m.text.lower() == '–Ω–æ—Ñ–∞–ø —Å—Ç–∞—Ä—Ç')
def start_nofap(m):
    uid, cid, name = m.from_user.id, m.chat.id, m.from_user.first_name
    
    res = db_query("SELECT attempts FROM users WHERE id = ? AND chat_id = ?", (uid, cid), fetch=True)
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞
    attempts = res[0][0] + 1 if res else 1
    
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    db_query("REPLACE INTO users VALUES (?, ?, ?, ?, ?)", (uid, cid, name, now, attempts))
    
    bot.reply_to(m, f"üöÄ {name}, –æ—Ç—Å—á–µ—Ç –ø–æ—à–µ–ª! –ü–æ–ø—ã—Ç–∫–∞ ‚Ññ{attempts}. –Ø —Å–ª–µ–∂—É –∑–∞ —Ç–æ–±–æ–π...")

@bot.message_handler(func=lambda m: m.text and m.text.lower() == '–º–æ–π –Ω–æ—Ñ–∞–ø')
def my_stats(m):
    res = db_query("SELECT start_time, attempts FROM users WHERE id = ? AND chat_id = ?", (m.from_user.id, m.chat.id), fetch=True)
    if not res: return bot.reply_to(m, "–¢—ã –Ω–µ –≤ –∏–≥—Ä–µ. –ü–∏—à–∏ '–Ω–æ—Ñ–∞–ø —Å—Ç–∞—Ä—Ç'")

    start_dt_str, attempts_val = res[0]
    start_dt = datetime.strptime(start_dt_str, "%Y-%m-%d %H:%M:%S")
    days = (datetime.now() - start_dt).days
    attempts = attempts_val
    
    status = "–í–æ–∏–Ω –°–≤–µ—Ç–∞" if attempts < 3 else random.choice(INSULTS)
    
    msg = (f"üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê:\n"
           f"üë§ –ò–º—è: {m.from_user.first_name}\n"
           f"üî• –°—Ç—Ä–∏–∫: {days} –¥–Ω.\n"
           f"üìâ –°—Ä—ã–≤–æ–≤: {attempts}\n"
           f"üèÜ –¢–≤–æ–π —Å—Ç–∞—Ç—É—Å: {status}")
    bot.reply_to(m, msg)

# --- –ê–í–¢–û-–§–£–ù–ö–¶–ò–ò (–¢–µ–≥–∏ –∏ –ú–æ—Ç–∏–≤–∞—Ü–∏—è) ---

def daily_check():
    users = db_query("SELECT id, chat_id, username, start_time FROM users", fetch=True)
    for u_id, c_id, name, s_time in users:
        start_dt = datetime.strptime(s_time, "%Y-%m-%d %H:%M:%S")
        delta = datetime.now() - start_dt
        
        # –¢–µ–≥–∞–µ–º –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞ (–µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ 1, 2, 3... –¥–Ω—è)
        # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –º–µ–Ω—å—à–µ —á–∞—Å–∞, –∑–Ω–∞—á–∏—Ç, —ç—Ç–æ –Ω–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ –¥–Ω—è
        if delta.days > 0 and delta.seconds < 3600: 
            bot.send_message(c_id, f"üîî –≠–π, [{name}](tg://user?id={u_id})! –ü–æ–∑–¥—Ä–∞–≤–ª—è—é, —Ç—ã –¥–µ—Ä–∂–∏—à—å—Å—è —É–∂–µ {delta.days} –¥–Ω.! –ü—Ä–æ–¥–æ–ª–∂–∞–π –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.", parse_mode="Markdown")

def broadcast_motivation():
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—É—é –º–æ—Ç–∏–≤–∞—Ü–∏—é –≤–æ –≤—Å–µ —á–∞—Ç—ã, –≥–¥–µ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    chats = db_query("SELECT DISTINCT chat_id FROM users", fetch=True)
    for (c_id,) in chats:
        bot.send_message(c_id, f"üì¢ **–ú–ò–ù–£–¢–ö–ê –ë–ê–ó–´:**\n{random.choice(MOTIVATION)}", parse_mode="Markdown")

def run_scheduler():
    schedule.every(1).hours.do(daily_check) # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —á–∞—Å, –ø–æ—Ä–∞ –ª–∏ –∫–æ–≥–æ-—Ç–æ —Ç–µ–≥–∞—Ç—å
    schedule.every(6).hours.do(broadcast_motivation) # –ú–æ—Ç–∏–≤–∞—Ü–∏—è —Ä–∞–∑ –≤ 6 —á–∞—Å–æ–≤
    while True:
        schedule.run_pending()
        time.sleep(60)

# --- –ó–ê–ü–£–°–ö ---

if __name__ == '__main__':
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    threading.Thread(target=run_scheduler, daemon=True).start()
    print("–í–æ—Ä–¥–µ–Ω –∑–∞–ø—É—â–µ–Ω...")
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º infinity_polling –¥–ª—è –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–π —Ä–∞–±–æ—Ç—ã
    bot.infinity_polling()
