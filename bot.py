import telebot
import sqlite3
import schedule
import time
import threading
import random
import os  # <-- Ð’ÐÐ–ÐÐž: Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
from datetime import datetime, timedelta

# ==================== Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐžÐ• ÐŸÐžÐ›Ð£Ð§Ð•ÐÐ˜Ð• Ð¢ÐžÐšÐ•ÐÐ ====================
# ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾ÐºÐµÐ½ Ð¸Ð· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ (Ð´Ð»Ñ Bothost)
TOKEN = os.getenv('TELEGRAM_BOT_TOKEN')

# Ð•ÑÐ»Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ Ð½ÐµÑ‚ (Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº), Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð° token.txt
if not TOKEN:
    try:
        with open('token.txt', 'r') as f:
            TOKEN = f.read().strip()
    except FileNotFoundError:
        pass

# Ð•ÑÐ»Ð¸ Ñ‚Ð¾ÐºÐµÐ½ Ñ‚Ð°Ðº Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ â€” Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð¿Ð¾Ð½ÑÑ‚Ð½ÑƒÑŽ Ð¾ÑˆÐ¸Ð±ÐºÑƒ
if not TOKEN:
    error_msg = """
    ÐžÐ¨Ð˜Ð‘ÐšÐ: Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!
    
    Ð¡ÐŸÐžÐ¡ÐžÐ‘Ð« Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ˜ Ð¢ÐžÐšÐ•ÐÐ:
    1. Ð”Ð›Ð¯ BOTHOST.RU (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ):
       - Ð’ Ð¿Ð°Ð½ÐµÐ»Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ:
         ÐšÐ»ÑŽÑ‡: TELEGRAM_BOT_TOKEN
         Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ: Ð²Ð°Ñˆ Ñ‚Ð¾ÐºÐµÐ½ Ð¾Ñ‚ @BotFather
    
    2. Ð”Ð›Ð¯ Ð›ÐžÐšÐÐ›Ð¬ÐÐžÐ“Ðž Ð—ÐÐŸÐ£Ð¡ÐšÐ:
       - Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð» token.txt Ð² Ð¾Ð´Ð½Ð¾Ð¹ Ð¿Ð°Ð¿ÐºÐµ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼
       - Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð² Ð½ÐµÐ³Ð¾ Ñ‚Ð¾ÐºÐµÐ½ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚Ð¾ÐºÐµÐ½, Ð±ÐµÐ· ÐºÐ°Ð²Ñ‹Ñ‡ÐµÐº)
    
    Ð¢Ð¾ÐºÐµÐ½ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñƒ @BotFather Ð² Telegram.
    """
    print(error_msg)
    raise ValueError("Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð¡Ð¼. Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑŽ Ð²Ñ‹ÑˆÐµ.")

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ Ð±Ð¾Ñ‚Ð° Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ‹Ð¼ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð¼
bot = telebot.TeleBot(TOKEN)
# =====================================================================

# --- Ð‘ÐÐ—Ð Ð”ÐÐÐÐ«Ð¥ ---
def db_query(query, params=(), fetch=False):
    """Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ SQLite"""
    with sqlite3.connect('nofap_ultra.db') as conn:
        cur = conn.cursor()
        cur.execute(query, params)
        if fetch: 
            return cur.fetchall()
        conn.commit()

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ, ÐµÑÐ»Ð¸ Ð¾Ð½Ð° Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
db_query('''CREATE TABLE IF NOT EXISTS users 
            (id INTEGER, chat_id INTEGER, username TEXT, start_time TEXT, attempts INTEGER, 
            PRIMARY KEY(id, chat_id))''')

# --- ÐšÐžÐÐ¢Ð•ÐÐ¢ (ÐœÐžÐ¢Ð˜Ð’ÐÐ¦Ð˜Ð¯ Ð˜ Ð£ÐÐ˜Ð–Ð•ÐÐ˜Ð¯) ---

MOTIVATION = [
    "ðŸ’ª Ð¢Ð²Ð¾Ñ ÑÐ½ÐµÑ€Ð³Ð¸Ñ â€” ÑÑ‚Ð¾ Ñ‚Ð²Ð¾Ð¹ Ð±ÐµÐ½Ð·Ð¸Ð½. ÐÐµ ÑÐ»Ð¸Ð²Ð°Ð¹ ÐµÐ³Ð¾ Ð² ÑƒÐ½Ð¸Ñ‚Ð°Ð·!",
    "ðŸ§  ÐœÐ¾Ð·Ð³ Ð±ÐµÐ· Ð´Ð¾Ñ„Ð°Ð¼Ð¸Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¼ÑƒÑÐ¾Ñ€Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð² 10 Ñ€Ð°Ð· Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ ÑÐ°Ð¼.",
    "ðŸ¦ Ð‘ÑƒÐ´ÑŒ Ð»ÑŒÐ²Ð¾Ð¼, Ð° Ð½Ðµ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ð½Ñ‹Ð¼ Ñ‚Ð°Ð¿Ð¾Ñ‡ÐºÐ¾Ð¼. Ð ÑƒÐºÐ¸ Ð½Ð° ÑÑ‚Ð¾Ð»!",
    "âš¡ï¸ Ð¢Ñ‹ ÑÑ‚Ñ€Ð¾Ð¸ÑˆÑŒ Ð»Ð¸Ñ‡Ð½Ð¾ÑÑ‚ÑŒ, Ð¸Ð»Ð¸ Ñ‚Ñ‹ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¼ÐµÑˆÐ¾Ðº Ñ Ð³Ð¾Ñ€Ð¼Ð¾Ð½Ð°Ð¼Ð¸? Ð’Ñ‹Ð±Ð¸Ñ€Ð°Ð¹.",
    "ðŸŒ… ÐŸÑ€ÐµÐ´ÑÑ‚Ð°Ð²ÑŒ, ÐºÐµÐ¼ Ñ‚Ñ‹ ÑÑ‚Ð°Ð½ÐµÑˆÑŒ Ñ‡ÐµÑ€ÐµÐ· Ð¼ÐµÑÑÑ† Ñ‡Ð¸ÑÑ‚Ð¾Ñ‚Ñ‹. Ð­Ñ‚Ð¾Ñ‚ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº ÐºÑ€ÑƒÑ‡Ðµ Ñ‚ÐµÐ±Ñ Ð² ÑÑ‚Ð¾ Ñ€Ð°Ð·.",
    "ðŸ’§ ÐšÐ°Ð¶Ð´Ð°Ñ ÐºÐ°Ð¿Ð»Ñ ÑÐ¿ÐµÑ€Ð¼Ñ‹ â€” ÑÑ‚Ð¾ ÑƒÑ‚Ñ€Ð°Ñ‡ÐµÐ½Ð½Ñ‹Ð¹ ÑˆÐ°Ð½Ñ Ð½Ð° Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ðµ. Ð”ÐµÑ€Ð¶Ð¸ Ð¾Ð±Ð¾Ñ€Ð¾Ð½Ñƒ!",
    "ðŸ”ï¸ ÐŸÑƒÑ‚ÑŒ Ðº Ð²ÐµÑ€ÑˆÐ¸Ð½Ðµ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ñ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð´Ð½Ñ Ð²Ð¾Ð·Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ñ. ÐÐµ ÑÑ€Ñ‹Ð²Ð°Ð¹ÑÑ Ð½Ð° ÑÑ‚Ð°Ñ€Ñ‚Ðµ.",
    "ðŸ‘‘ Ð¡Ð°Ð¼Ð¾ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ â€” ÑÑ‚Ð¾ ÑÑƒÐ¿ÐµÑ€ÑÐ¸Ð»Ð°. Ð¢Ñ‹ Ð¼Ð¾Ð¶ÐµÑˆÑŒ ÐµÐµ Ñ€Ð°Ð·Ð²Ð¸Ñ‚ÑŒ!",
    "â³ Ð’Ñ€ÐµÐ¼Ñ, Ð¿Ð¾Ñ‚Ñ€Ð°Ñ‡ÐµÐ½Ð½Ð¾Ðµ Ð½Ð° ÑÐ»Ð°Ð±Ð¾ÑÑ‚ÑŒ, Ð½Ð¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ Ð²ÐµÑ€Ð½ÐµÑ‚ÑÑ. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐµÐ³Ð¾ Ð¼ÑƒÐ´Ñ€Ð¾.",
    "ðŸ’¡ Ð§Ð¸ÑÑ‚Ñ‹Ð¹ Ñ€Ð°Ð·ÑƒÐ¼ Ð²Ð¸Ð´Ð¸Ñ‚ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ñ‚Ð°Ð¼, Ð³Ð´Ðµ Ð³Ñ€ÑÐ·Ð½Ñ‹Ð¹ Ð²Ð¸Ð´Ð¸Ñ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹. ÐžÑÑ‚Ð°Ð²Ð°Ð¹ÑÑ Ñ‡Ð¸ÑÑ‚Ñ‹Ð¼!"
]

INSULTS = [
    "ðŸ¤¡ ÐžÐ¿ÑÑ‚ÑŒ? Ð¢Ð²Ð¾Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ ÑÐ°Ð¼Ð¾ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ñ Ð½Ð¸Ð¶Ðµ, Ñ‡ÐµÐ¼ Ñƒ Ð¸Ð½Ñ„ÑƒÐ·Ð¾Ñ€Ð¸Ð¸-Ñ‚ÑƒÑ„ÐµÐ»ÑŒÐºÐ¸.",
    "ðŸ‘‹ Ð¢Ð²Ð¾Ñ Ð¿Ñ€Ð°Ð²Ð°Ñ Ñ€ÑƒÐºÐ° ÑƒÐ¶Ðµ Ð¿Ð¾Ð´Ð°Ð»Ð° Ð½Ð° Ñ‚ÐµÐ±Ñ Ð² ÑÑƒÐ´ Ð·Ð° ÑÐºÑÐ¿Ð»ÑƒÐ°Ñ‚Ð°Ñ†Ð¸ÑŽ.",
    "ðŸ“‰ Ð¢Ð²Ð¾Ð¹ Ñ‚ÐµÑÑ‚Ð¾ÑÑ‚ÐµÑ€Ð¾Ð½ Ð¿Ð¾ÐºÐ¸Ð½ÑƒÐ» Ñ‡Ð°Ñ‚. ÐžÑÑ‚Ð°Ð»Ð¾ÑÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ€Ð°Ð·Ð¾Ñ‡Ð°Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ.",
    "ðŸŒ Ð¢Ñ‹ Ð´Ð²Ð¸Ð¶ÐµÑˆÑŒÑÑ Ð¿Ð¾ Ð¶Ð¸Ð·Ð½Ð¸ ÑÐ¾ ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒÑŽ ÑƒÐ»Ð¸Ñ‚ÐºÐ¸, Ð¿Ð¾Ñ‚Ð¾Ð¼Ñƒ Ñ‡Ñ‚Ð¾ Ð±ÑƒÐºÑÑƒÐµÑˆÑŒ Ð² ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð¹ Ð»ÑƒÐ¶Ðµ.",
    "ðŸ¦¾ Ð¢Ð²Ð¾Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ: 'ÐŸÑ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð½Ð°Ñ‚Ð¸Ñ€Ð°Ð»ÑŒÑ‰Ð¸Ðº'. ÐŸÐ¾Ð·Ð¾Ñ€ Ñ‡Ð°Ñ‚Ð°!",
    "ðŸ§€ Ð¢Ð²Ð¾Ñ Ð²Ð¾Ð»Ñ Ð¼ÑÐ³Ñ‡Ðµ, Ñ‡ÐµÐ¼ Ð¿Ð»Ð°Ð²Ð»ÐµÐ½Ñ‹Ð¹ ÑÑ‹Ñ€Ð¾Ðº Ð½Ð° ÑÐ¾Ð»Ð½Ñ†Ðµ.",
    "ðŸš½ ÐšÐ°Ð¶ÐµÑ‚ÑÑ, Ñ‚Ñ‹ Ð¿ÐµÑ€ÐµÐ¿ÑƒÑ‚Ð°Ð» ÑÐ²Ð¾Ðµ Ð¿Ñ€Ð¸Ð·Ð²Ð°Ð½Ð¸Ðµ Ñ ÐºÐ°Ð½Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÐµÐ¹. Ð¥Ð²Ð°Ñ‚Ð¸Ñ‚ ÑÐ»Ð¸Ð²Ð°Ñ‚ÑŒ ÑÐ½ÐµÑ€Ð³Ð¸ÑŽ!",
    "ðŸ§¦ ÐŸÐ¾Ñ…Ð¾Ð¶Ðµ, Ñ‚Ð²Ð¾Ñ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ñ Ð½Ð¾ÑÐºÐ¾Ð² Ð¿Ð¾Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ñ‡Ð°Ñ‰Ðµ, Ñ‡ÐµÐ¼ Ñ‚Ð²Ð¾Ð¹ ÑÑ‚Ñ€Ð¸Ðº.",
    "ðŸ‘¹ Ð¡Ð¼Ð¾Ñ‚Ñ€Ð¸Ñ‚ Ð½Ð° Ð¼Ð¸Ñ€ Ñ‡ÐµÑ€ÐµÐ· Ð¿Ñ€Ð¸Ð·Ð¼Ñƒ Ð¿Ð¾Ñ€Ð½Ð¾Ñ…Ð°Ð±Ð°. Ð’ÐµÑ€Ð½Ð¸ÑÑŒ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ, ÑÐ»Ð°Ð±Ð°Ðº!",
    "ðŸ’ Ð–Ð¸Ð²Ð¾Ñ‚Ð½Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ð¸Ð½ÐºÑ‚Ñ‹ Ð¿Ð¾Ð±ÐµÐ´Ð¸Ð»Ð¸ Ñ‚Ð²Ð¾Ð¹ Ñ€Ð°Ð·ÑƒÐ¼. Ð­Ð²Ð¾Ð»ÑŽÑ†Ð¸Ñ Ð¿Ð¾ÑˆÐ»Ð° Ð²ÑÐ¿ÑÑ‚ÑŒ."
]

# --- ÐšÐžÐœÐÐÐ”Ð« ---

@bot.message_handler(func=lambda m: m.text and m.text.lower() == 'Ð½Ð¾Ñ„Ð°Ð¿ ÑÑ‚Ð°Ñ€Ñ‚')
def start_nofap(m):
    """ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð¾Ñ‚ÑÑ‡ÐµÑ‚Ð°"""
    uid, cid, name = m.from_user.id, m.chat.id, m.from_user.first_name
    
    res = db_query("SELECT attempts FROM users WHERE id = ? AND chat_id = ?", 
                   (uid, cid), fetch=True)
    
    # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð½Ð¾Ð¼ÐµÑ€ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸
    attempts = res[0][0] + 1 if res else 1
    
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    db_query("REPLACE INTO users VALUES (?, ?, ?, ?, ?)", 
             (uid, cid, name, now, attempts))
    
    bot.reply_to(m, f"ðŸš€ {name}, Ð¾Ñ‚ÑÑ‡ÐµÑ‚ Ð¿Ð¾ÑˆÐµÐ»! ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° â„–{attempts}. Ð¯ ÑÐ»ÐµÐ¶Ñƒ Ð·Ð° Ñ‚Ð¾Ð±Ð¾Ð¹...")

@bot.message_handler(func=lambda m: m.text and m.text.lower() == 'Ð¼Ð¾Ð¹ Ð½Ð¾Ñ„Ð°Ð¿')
def my_stats(m):
    """ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ"""
    res = db_query("SELECT start_time, attempts FROM users WHERE id = ? AND chat_id = ?", 
                   (m.from_user.id, m.chat.id), fetch=True)
    
    if not res: 
        return bot.reply_to(m, "Ð¢Ñ‹ Ð½Ðµ Ð² Ð¸Ð³Ñ€Ðµ. ÐŸÐ¸ÑˆÐ¸ 'Ð½Ð¾Ñ„Ð°Ð¿ ÑÑ‚Ð°Ñ€Ñ‚'")

    start_dt_str, attempts_val = res[0]
    start_dt = datetime.strptime(start_dt_str, "%Y-%m-%d %H:%M:%S")
    days = (datetime.now() - start_dt).days
    attempts = attempts_val
    
    # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ: Ð¿ÐµÑ€Ð²Ñ‹Ðµ 2 Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ - Ð²Ð¾Ð¸Ð½, Ð´Ð°Ð»ÐµÐµ - ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ðµ ÑƒÐ½Ð¸Ð¶ÐµÐ½Ð¸Ðµ
    status = "Ð’Ð¾Ð¸Ð½ Ð¡Ð²ÐµÑ‚Ð°" if attempts < 3 else random.choice(INSULTS)
    
    msg = (f"ðŸ“Š Ð¡Ð¢ÐÐ¢Ð˜Ð¡Ð¢Ð˜ÐšÐ:\n"
           f"ðŸ‘¤ Ð˜Ð¼Ñ: {m.from_user.first_name}\n"
           f"ðŸ”¥ Ð¡Ñ‚Ñ€Ð¸Ðº: {days} Ð´Ð½.\n"
           f"ðŸ“‰ Ð¡Ñ€Ñ‹Ð²Ð¾Ð²: {attempts}\n"
           f"ðŸ† Ð¢Ð²Ð¾Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑ: {status}")
    bot.reply_to(m, msg)

# --- ÐÐ’Ð¢Ðž-Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜ (Ð¢ÐµÐ³Ð¸ Ð¸ ÐœÐ¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ) ---

def daily_check():
    """Ð•Ð¶ÐµÑ‡Ð°ÑÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð»Ñ Ñ‚ÐµÐ³Ð° Ð¿Ð¾ Ð´Ð½ÑÐ¼"""
    try:
        users = db_query("SELECT id, chat_id, username, start_time FROM users", fetch=True)
        for u_id, c_id, name, s_time in users:
            start_dt = datetime.strptime(s_time, "%Y-%m-%d %H:%M:%S")
            delta = datetime.now() - start_dt
            
            # Ð¢ÐµÐ³Ð°ÐµÐ¼ Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð´Ð½Ñ (Ð¿ÐµÑ€Ð²Ñ‹Ðµ 3600 ÑÐµÐºÑƒÐ½Ð´ Ð´Ð½Ñ)
            if delta.days > 0 and delta.seconds < 3600: 
                bot.send_message(c_id, 
                               f"ðŸ”” Ð­Ð¹, [{name}](tg://user?id={u_id})! ÐŸÐ¾Ð·Ð´Ñ€Ð°Ð²Ð»ÑÑŽ, Ñ‚Ñ‹ Ð´ÐµÑ€Ð¶Ð¸ÑˆÑŒÑÑ ÑƒÐ¶Ðµ {delta.days} Ð´Ð½.! ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°Ð¹ Ð² Ñ‚Ð¾Ð¼ Ð¶Ðµ Ð´ÑƒÑ…Ðµ.", 
                               parse_mode="Markdown")
    except Exception as e:
        print(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð² daily_check: {e}")

def broadcast_motivation():
    """Ð Ð°ÑÑÑ‹Ð»ÐºÐ° Ð¼Ð¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 6 Ñ‡Ð°ÑÐ¾Ð²"""
    try:
        chats = db_query("SELECT DISTINCT chat_id FROM users", fetch=True)
        for (c_id,) in chats:
            bot.send_message(c_id, 
                           f"ðŸ“¢ **ÐœÐ˜ÐÐ£Ð¢ÐšÐ Ð‘ÐÐ—Ð«:**\n{random.choice(MOTIVATION)}", 
                           parse_mode="Markdown")
    except Exception as e:
        print(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð² broadcast_motivation: {e}")

def run_scheduler():
    """Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸ÐºÐ° Ð² Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ð¼ Ð¿Ð¾Ñ‚Ð¾ÐºÐµ"""
    schedule.every(1).hours.do(daily_check)  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ñ
    schedule.every(6).hours.do(broadcast_motivation)  # ÐœÐ¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ñ€Ð°Ð· Ð² 6 Ñ‡Ð°ÑÐ¾Ð²
    
    while True:
        try:
            schedule.run_pending()
            time.sleep(60)  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ð¶Ð´ÑƒÑŽ Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
        except Exception as e:
            print(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð² Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸ÐºÐµ: {e}")
            time.sleep(60)

# --- Ð—ÐÐŸÐ£Ð¡Ðš ---

if __name__ == '__main__':
    print("=" * 50)
    print("ðŸ¤– NOFAP WARDEN Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ...")
    print(f"âœ… Ð¢Ð¾ÐºÐµÐ½ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½: {'Ð”Ð°' if TOKEN else 'ÐÐµÑ‚'}")
    print("=" * 50)
    
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸Ðº Ð² Ñ„Ð¾Ð½Ð¾Ð²Ð¾Ð¼ Ð¿Ð¾Ñ‚Ð¾ÐºÐµ
    scheduler_thread = threading.Thread(target=run_scheduler, daemon=True)
    scheduler_thread.start()
    print("ðŸ“… Ð¤Ð¾Ð½Ð¾Ð²Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹")
    
    # ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ñ†Ð¸ÐºÐ» Ð±Ð¾Ñ‚Ð°
    print("ðŸ”„ Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½. ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´...")
    print("Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹: 'Ð½Ð¾Ñ„Ð°Ð¿ ÑÑ‚Ð°Ñ€Ñ‚', 'Ð¼Ð¾Ð¹ Ð½Ð¾Ñ„Ð°Ð¿'")
    print("-" * 50)
    
    try:
        bot.infinity_polling()
    except KeyboardInterrupt:
        print("\nðŸ›‘ Ð‘Ð¾Ñ‚ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼")
    except Exception as e:
        print(f"âŒ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°: {e}")